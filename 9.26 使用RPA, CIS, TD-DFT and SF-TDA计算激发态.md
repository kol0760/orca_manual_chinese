## 9.26 使用RPA, CIS, TD-DFT and SF-TDA计算激发态

ORCA软件具备相对高效的单激发CI(CI, configuration interaction)、"随机相位近似"（RPA）和时依赖密度泛函理论（TD-DFT）模块，可用于计算激发能量、吸收强度和CD(CD, circular dichroism )强度。特别是TD-DFT，由于其提供的结果明显优于同等成本的HF-CIS，因而在激发态计算中变得非常流行。然而，TD-DFT也存在许多缺陷，一些评论中对此进行了讨论。TD-DFT方法适用于闭壳层和非限制性自旋参考态，以及其自旋翻转变体。对于这些体系，都提供了解析梯度。此外，还实现了一种双重修正，它可以改进结果（但也增加了计算成本）。这种修正经常与双杂化泛函一起使用，如下文所述。ORCA的TD-DFT模块也广泛用于计算给定元素K边缘的X射线吸收光谱。

### 9.26.1 一般特征

使用以下块调用该模块
```orca
%cis end
# or equivalently
%tddft end
```
有许多设置可以调整。其中最重要的是你想要计算的激发态数目：
```orca
%cis NRoots 10 end
```
收敛公差由下式给出：
```orca
%cis
...
ETol 1e-6
RTol 1e-6
end
```
变量**ETol**表示激发态能量所需的收敛精度（以Eh为单位），而**RTol**是残差向量范数所需的收敛精度。在正常情况下，计算需要大约5-10次迭代才能达到默认的收敛公差。
一旦收敛，程序会打印波函数组成。为了保持打印内容的简洁，小于0.01的系数将被省略。可以使用关键词**TPrint**调整这个阈值。
```orca
%cis
...
TPrint 0.0001 # cut-off for the wave function printing, default= 0.01
end
```

如果使用闭壳层参考状态，程序可以通过以下方式同时计算单重态和自旋适应的三重态激发态：
```orca
%cis
...
triplets true
end
```
这适用于所有方法的组合，包括解析梯度，以及对于双重杂化方法。
为了控制计算中应考虑的轨道，有两种机制可用。第一种机制是默认机制，它包括指定一个轨道能量窗口，在此窗口内，所有单激发都将被考虑：
```orca
%cis
...
EWin -3,3 # (orbital energy window in Eh)
end
```
因此，默认设置是保持核心轨道冻结，并忽略非常高能级的虚拟轨道，这是一个合理的近似。然而，你可能想要考虑包含所有虚拟轨道，例如选择**EWin -3,10000**。第二种机制是为每个算子显式地给出一个轨道能量窗口，即：
```
%cis
...
OrbWin[0] = 2,-1,-1,14 # orbital window for spin-up MOs
OrbWin[1] = 2,-1,-1,16 # orbital window for spin-down MOs
end
```
上例中的 “-1” 表示自旋向上和自旋向下轨道的 HOMO 和 LUMO 将由程序自动确定。 换句话说，在上面的例子中，TD-DFT计算中只包含以下激励：

- 从任何占据的α轨道激发，其轨道指数在2（包括）和αHOMO（最高占据分子轨道，包括）之间，到任何虚拟的α轨道，其轨道指数在αLUMO（最低未占据分子轨道，包括）和14（包括）之间。
- 从任何占据的β轨道激发，其轨道指数在2（包括）和βHOMO（最高占据分子轨道，包括）之间，到任何虚拟的β轨道，其轨道指数在βLUMO（最低未占据分子轨道，包括）和16（包括）之间。

对于基于受限参考的计算，OrbWin[1]将被忽略。
在使用CIS/TD-DFT模块时，应区分五种不同类型的计算：

1. 半经验方法

2. HF计算
3. 无需HF交换的DFT计算（非混合泛函）
4. 使用HF交换进行DFT计算（混合泛函）
5. 具有HF交换和MP2相关性的DFT计算（双混合泛函）

### 9.26.2 半经验方法

半经验INDO/S方法非常适合计算大中型有机和无机分子的吸收光谱。已故的M. C. Zerner已将其参数化，用于光学光谱学，根据我的经验，它对大多数体系都很有效。使用半经验方法可以轻松计算大分子的许多状态。例如，考虑以下对双组氨酸配位的铁卟啉模型（Fe(II)状态）的计算，该模型包含92个原子和约16,500个单激发空间的CSFs（组态状态函数）。然而，预测前40个激发态的计算只需在普通计算机上花费几分钟。

计算出的光谱基本上与实验结果相符，显示出在400 nm左右（著名的Soret带）有一个巨大的带，以及在500到550 nm之间（Q带）有一个较小但仍然强烈的带。预测中没有低于约10,000 /cm的吸收。

计算的输入文件如下所示：

```orca
# Test CIS in conjunction with INDO/S
! ZINDO/S TightSCF DIIS NoMOPrint
%cis NRoots 40
end
* xyz   0   1
Fe  -0.01736     0.71832    -0.30714 
C    2.65779     4.03195    -0.13175 
C    3.51572     3.02488    -0.24101 
C    2.66971     1.82027    -0.30891 
C    3.30062     0.51609    -0.42755 
C    2.61022    -0.60434    -0.47131 
C    3.32146    -1.89491    -0.57434 
C    2.35504    -2.79836    -0.57179 
C    1.11740    -1.99868    -0.46878 
C   -0.04908    -2.61205    -0.44672 
C   -1.30967    -1.89127    -0.38984 
C   -2.58423    -2.63345    -0.40868 
C   -3.50492    -1.68283    -0.37930 
C   -2.72946    -0.42418    -0.33711 
C   -3.35747     0.73319    -0.28970 
C   -2.66935     2.01561    -0.22869 
C   -3.31167     3.19745    -0.16277 
C   -4.72835     3.62642    -0.14517 
C   -5.84825     2.89828    -0.20597 
C   -2.21443     4.15731    -0.09763 
C   -1.11572     3.39398    -0.14235 
C    0.19578     4.02696    -0.10122 
C    1.33370     3.36290    -0.15370 
C    3.09165     5.44413    -0.02579 
C    2.35656     6.55323     0.10940 
N    1.43216     2.09428    -0.24815 
N    1.34670    -0.74673    -0.42368 
N   -1.39885     2.15649    -0.21891 
N   -1.47620    -0.63353    -0.34705 
C    5.03025     3.02708    -0.28544 
C    4.81527    -2.12157    -0.66646 
C   -5.01065    -1.83771    -0.38886 
C   -2.28137     5.66820    -0.00321 
C   -2.73691    -4.14249    -0.43699 
C   -2.42579    -4.72805    -1.83259 
C    2.45978    -4.31073    -0.64869 
C    2.19678    -4.82182    -2.08201 
C    1.60835    -6.22722    -2.10748 
C   -1.90102    -6.15737    -1.82447 
O   -1.96736    -6.92519    -2.75599 
O    1.60982    -7.01844    -1.19330 
O   -1.15355    -6.41323    -0.74427 
O    0.89871    -6.41433    -3.22828 
H    4.17823     5.62170    -0.05623 
H    2.86221     7.53117     0.17503 
H    1.26303     6.57673     0.17212 
H    0.21799     5.11603    -0.03468 
H   -1.78003     6.14426    -0.87498 
H   -3.32281     6.05139     0.01906 
H   -1.78374     6.03115     0.92347 
H   -4.89690     4.71221    -0.07358 
H   -6.82566     3.40843    -0.18007 
H   -5.88239     1.80643    -0.28628 
H   -4.44893     0.70720    -0.28575 
H   -5.32107    -2.89387    -0.54251 
H   -5.45075    -1.49552     0.57400 
H   -5.46788    -1.24144    -1.20929 
H   -2.05997    -4.55939     0.34045 
H   -3.76430    -4.43895    -0.12880 
H   -3.33638    -4.66246    -2.47119 
H   -1.65517    -4.10119    -2.33605 
H   -0.56422    -7.14866    -1.00437 
H    0.26056    -7.12181    -3.00953 
H    1.48118    -4.13253    -2.58671 
H    3.13949    -4.79028    -2.67491 
H    3.46153    -4.65168    -0.30336 
H    1.73023    -4.75206     0.06633 
H    5.26172    -1.51540    -1.48550 
H    5.31767    -1.84036     0.28550 
H    5.06416    -3.18438    -0.87628 
H   -0.07991    -3.70928    -0.48866 
H    4.39835     0.46775    -0.47078 
H    5.39550     2.59422    -1.24309 
H    5.47197     4.04179    -0.19892 
H    5.44914     2.41988     0.54738 
N    0.01831     0.60829     1.68951 
C    0.02054     1.64472     2.54371 
C    0.04593    -0.50152     2.45186 
N    0.04934     1.20474     3.84418 
C    0.06582    -0.16578     3.80848 
H    0.00322     2.72212     2.31829 
N   -0.05051     0.81937    -2.30431 
H    0.05251    -1.53704     2.08183 
C    0.11803     1.92670    -3.04495 
H    0.05712     1.81091     4.70485 
H    0.08982    -0.83278     4.68627 
C   -0.24302    -0.18840    -3.17641 
C   -0.19749     0.28568    -4.49059 
N    0.03407     1.63309    -4.38373 
H    0.30109     2.95786    -2.70479 
H   -0.41432    -1.24242    -2.91290 
H   -0.31761    -0.27403    -5.43315 
H    0.12975     2.31943    -5.17616 
*
```
<div align="center">
    <img src="https://i.imgur.com/4856Ir7.png" width="55%" />
    <center style="font-size:12px;color:#999;">
        <strong style="color:black;">
            图9.23 用于预测其吸收光谱的铁卟啉的结构（该结构由分子力学计算得到，铁-咪唑键长设置为2.0 Å）</strong>
    </center> 
</div>


<div align="center">
    <img src="https://i.imgur.com/SngUt4F.png" width="55%" />
    <center style="font-size:12px;color:#999;">
        <strong style="color:black;">
            图9.24 ZINDO/S预测的铁卟啉模型的吸收光谱如上所示。频谱是使用orcamappc工具绘制的。</strong>
    </center> 
</div>


请注意，ORCA在使用ZINDO/S的标准方法时略有不同，它在强度计算中使用偶极积分，包括所有一阶中心和两阶中心项，这些项是通过STO-3G展开的Slater基轨道来计算的。计算出的强度并不是非常精确。在目前的情况下，它们被高估了大约2倍。

### 9.26.3 HF波函数

当将上述过程应用于纯 Hartree-Fock时，可以得到“随机相位近似”(RPA)或CIS模型（当有效使用Tamm-Dancoff近似时，TDA）。一般来说，RPA和CIS计算与实验激发能量并不能很好地吻合，并且1-5 eV的误差很常见。因此，HF/CIS主要是一种定性工具，或者如果更广泛和更平衡的CI计算在计算上难以处理，则可以谨慎用于较大分子。

### 9.26.4 Non-Hybrid and Hybrid DFT

在密度泛函理论（DFT）方法中，对于TD-DFT的处理，可以选择完整的TD-DFT（如公式9.284所示）或所谓的Tamm-Dancoff近似（TDA）。

$$
\left(\begin{array}{cc}
\mathrm{A} & \mathrm{B} \\
\mathrm{B}^* & \mathrm{~A}^*
\end{array}\right)\left(\begin{array}{c}
\mathrm{X} \\
\mathrm{Y}
\end{array}\right)=\left(\begin{array}{cc}
\omega & 0 \\
0 & -\omega
\end{array}\right)\left(\begin{array}{c}
\mathrm{X} \\
\mathrm{Y} \\
\tag{公式9.284}
\end{array}\right)
$$

TDA与从RPA到CIS的近似值相同（即忽略所谓的**B**矩阵，参见公式9.285）。两种方法之间的垂直激发能量结果通常非常相似。

$$
\mathbf{A X}_{\mathrm{TDA}}=\omega_{\mathrm{TDA}} \mathbf{X}_{\mathrm{TDA}}
\tag{公式9.285}
$$

通常情况下，在自旋限制条件下单重态至单重态激发的矩阵**A**和**B**的元素由方程9.286和9.287给出。

$$
A_{i a, j b}= & \delta_{i j} \delta_{a b}\left(\epsilon_a-\epsilon_i\right)+2(i a \mid j b)-a_{\mathrm{X}}(i j \mid a b) \\
& +\left(1-a_{\mathrm{X}}\right)\left(i a\left|f_{\mathrm{XC}}\right| j b\right)
\tag{公式9.286}
$$

$$
B_{i a, j b}=2(i a \mid b j)-a_{\mathrm{X}}(i b \mid a j)\\
+\left(1-a_x\right)\left(i a\left|f_{\mathrm{XC}}\right| b j\right) 
\tag{公式9.287}
$$

在这里，*i , j* 表示被占据的轨道，而*a , b*表示虚拟轨道。 ***aX*** 是密度泛函中非局域Fock交换的量。如果 ***aX*** 等于1，方程9.284 和9.285 对应于基于哈特里-福克基态行列式的RPA和CIS情况。
TDA 实际上是 TD-DFT 的默认方法，并且可以通过以下方式关闭：

```orca
%tddft TDA false # (default)
end
```

在某些情况下，混合泛函比纯泛函提供显著更好的结果，因为它们较少受到自相互作用误差的影响。在这些情况下，RIJCOSX过程可以在这类计算中带来非常大的速度提升，几乎不损失精度，并且当SCF使用该方法时，默认会开启。

### 9.26.5 共线自旋翻转 TDA (SF-TD-DFT)
通过CIS/TD-DFT获得激发态的另一种方法是所谓的自旋翻转方法。其思想是从一个UHF状态开始，然后将其中一个α电子“翻转”以生成$M S_{SF}=M S_{UHF}-1$的状态。为此，我们只寻找从α到β轨道的激发，这使得TDA中的A矩阵变得更加简单：

$$
A_{i \bar{a}, j \bar{b}}^{S F}=\delta_{i j} \delta_{\bar{a} \bar{b}}\left(\epsilon_{\bar{a}}-\epsilon_i\right)-a_{\mathrm{X}}(i j \mid \bar{a} \bar{b})
\tag{公式9.288}
$$

其中上划线的代表β轨道，无上划线的代表α轨道。
注：请注意，对于纯DFT（ $a_X=0$ ，无HF贡献），A矩阵仅基于轨道能量，因此在泛函中拥有足够好的HF是有必要的！
为了便于讨论从 SF-TDA 得到的结果，让我们更仔细地看看代表一些可能激发态的图片：
需要注意的是，并非所有的 SF 激发都会导致是 $S^2$ 算子的特征值的行列式。这意味着，根据最终 SF 状态中“自旋不完备”激发的数量，自旋污染可能会很高，在这种情况下，会预测出$\left\langle S^2\right\rangle \simeq 1$的状态。这些在 SF 理论中是未定义的状态，应该谨慎对待。

<div align="center">
    <img src="https://i.imgur.com/FA9idQ1.png" width="75%" />
    <center style="font-size:12px;color:#999;">
        <strong style="color:black;">
            图9.25 自旋翻转算子对UHF（MS = 3）波函数的影响。所谓的“自旋完备”状态是S2算子的特征向量，而“自旋不完备”的则不是。为了简化图像，这里的α和β轨道被表示为具有相同的能量。</strong>
    </center> 
</div>

注：任何SF方法只能从至少具有3重态的UHF波函数开始使用！

#### 9.26.5.1 第一个例子：亚甲基和SF-CIS
一个简单的例子是使用CIS计算亚甲基自由基的垂直单重态-三重态分裂，使用包含对称性的以下输入：

```orca
!HF 6-31G USESYM
%TDDFT SF TRUE END
* XYZ 0 3
C 0 0 0.1058
H 0 0.9910 -0.3174
H 0 -.9910 -.3174
*
```

该几何结构取自高水平CCSD(T)/cc-pVQZ (X3B1)优化的几何结构，经过常规的UHF SCF后，得到的SF-CIS结果是：

```
---------------------
SF-CIS EXCITED STATES
---------------------
the weight of the individual excitations are printed if larger than 1.0e-02
(SPIN-FLIP GROUND STATE)
STATE 1: E= 0.004953 au 0.135 eV 1087.0 cm**-1 <S**2> = 2.044208 Sym: B1
1a -> 3b : 0.018853 (c= 0.13730475)
3a -> 3b : 0.474153 (c= -0.68858776)
3a -> 10b : 0.015096 (c= -0.12286571)
4a -> 4b : 0.451519 (c= 0.67195159)
4a -> 9b : 0.023981 (c= 0.15485668)
STATE 2: E= 0.065212 au 1.774 eV 14312.3 cm**-1 <S**2> = 0.019616 Sym: A1
3a -> 4b : 0.126253 (c= 0.35532096)
4a -> 3b : 0.833446 (c= -0.91293269)
4a -> 10b : 0.017089 (c= -0.13072354)
STATE 3: E= 0.085608 au 2.330 eV 18788.7 cm**-1 <S**2> = 0.028873 Sym: B1
3a -> 3b : 0.461538 (c= 0.67936623)
3a -> 10b : 0.010687 (c= 0.10337584)
4a -> 4b : 0.497210 (c= 0.70513090)
4a -> 9b : 0.018632 (c= 0.13649832)
```
现在，非常重要的一点是要认识到，SF基态不再是UHF基态。在SF方案中的“新”基态实际上是STATE 1。你可以将UHF看作仅仅是一个初始模型，SF状态是基于此构建的。新基态的最终能量实际上是SCF能量加上STATE 1的能量（如果没有给出IROOT，这就是作为FINAL SINGLE POINT ENERGY给出的那个）。这最后的贡献可能是正的或负的，这取决于具体案例。
无论如何，基态被预测为三重态（这里的$M_S= 0$），正如预期的那样，对于这种卡宾来说，并且S-T分裂能量是$1.774 eV- 0.135 eV = 1.639 eV$。全CI结果为$1.50 eV$，所以已经几乎接近了！当然，在这种情况下计算RHF单重态 - UHF三重态是没有意义的，因为RHF单重态不会具有必要的开壳层单重态特征。
#### 9.26.5.2 对苯炔和SF-TDA
苯炔是一种经典的双自由基，可以通过苯夺氢生成（图 9.26）。 已知它具有开壳层单线态基态，并且通过实验测量了其绝热单线态-三线态分裂。 让我们尝试使用ORCA的SF-TDA方法来计算该值。

<div align="center">
    <img src="https://i.imgur.com/y150ATA.png" width="55%" />
    <center style="font-size:12px;color:#999;">
        <strong style="color:black;">
            图9.26 苯和苯炔分子的路易斯表示，后者具有双自由基特征。
</strong>
    </center> 
</div>

首先，我们通过使用SF来优化开壳层单重态，具体方法如下。在这里，我们现在使用DFT，特别是BHANDHLYP泛函，该泛函使用了50%的HF相关性，适用于这类应用。默认情况下，要优化的IROOT是1，这在这种情况下对应于SF基态。

```orca
!BHANDHLYP DEF2-TZVPD OPT
%TDDFT SF TRUE
NROOTS 3
END
* xyz 0 3
C -1.39113  0.00000  0.00000
C  0.69557  1.20476  0.00000
C -0.69557  1.20476  0.00000
C -0.69557 -1.20476  0.00000
C  0.69557 -1.20476  0.00000
C  1.39113  0.00000  0.00000
H -1.24291  2.15278  0.00000
H -1.24291 -2.15278  0.00000
H  1.24291 -2.15278  0.00000
H  1.24291  2.15278  0.00000
```

在优化了IROOT 1之后，最终的SF-TDA结果是：

```orca
---------------------
SF-TDA EXCITED STATES
---------------------
the weight of the individual excitations are printed if larger than 1.0e-02
(SPIN-FLIP GROUND STATE)
STATE 1: E= 0.024231 au 0.659 eV 5318.2 cm**-1 <S**2> = 0.023398
11a -> 19b : 0.018546 (c= -0.13618298)
17a -> 20b : 0.245671 (c= -0.49565233)
17a -> 27b : 0.016834 (c= 0.12974401)
20a -> 19b : 0.666596 (c= -0.81645317)
20a -> 25b : 0.020096 (c= 0.14176006)
STATE 2: E= 0.032598 au 0.887 eV 7154.5 cm**-1 <S**2> = 2.018033
11a -> 20b : 0.015438 (c= -0.12424884)
17a -> 19b : 0.448627 (c= -0.66979616)
17a -> 25b : 0.017992 (c= 0.13413494)
20a -> 20b : 0.460929 (c= -0.67891734)
20a -> 27b : 0.024021 (c= 0.15498845)
STATE 3: E= 0.106572 au 2.900 eV 23389.9 cm**-1 <S**2> = 1.029619
15a -> 20b : 0.051524 (c= 0.22698827)
18a -> 19b : 0.910478 (c= -0.95418975)
18a -> 25b : 0.017481 (c= 0.13221571)
```

确认了单重态基态，以及上层的三重态激发态。
现在要使用 SF-TDA 优化三重态，必须使用类似的输入，只不过现在必须选择IROOT 2作为要优化的输入：

```orca
!BHANDHLYP DEF2-TZVPD OPT
%TDDFT SF TRUE
NROOTS 3
IROOT 2
END
* xyz 0 3
C -1.39113  0.00000  0.00000
C  0.69557  1.20476  0.00000
C -0.69557  1.20476  0.00000
C -0.69557 -1.20476  0.00000
C  0.69557 -1.20476  0.00000
C  1.39113  0.00000  0.00000
H -1.24291  2.15278  0.00000
H -1.24291 -2.15278  0.00000
H  1.24291 -2.15278  0.00000
H  1.24291  2.15278  0.00000
*
```

优化后，最终预测的绝热单重态-三重态能隙为0.163 eV，非常接近实验值0.165 eV，甚至优于破缺对称（BS）结果（0:074 eV） ）。

| method | $\Delta_{S T}^{a d}(e V)$ | 
| :---:  |      :---:   | 
| Exp    | 0.165 ± 0.016|
| SF-TDA |         0.163|
|CCSD(dT)|         0.172|
|△UKS   |         1.477|
|BS      |         0.074|

### 9.26.6 Including solvation effects via LR-CPCM theory

#### 9.26.6.1 Equilibrium and non-equilibrium conditions

#### 9.26.6.2 Population Analysis of Excited States

### 9.26.7 Simplified TDA and TD-DFT

#### 9.26.7.1 Theoretical Background

#### 9.26.7.2 Calculation Set-up

### 9.26.8 Double-hybrid functionals and Doubles Correction

### 9.26.9 Natural Transition Orbitals

### 9.26.10 Computational Aspects

### 9.26.11 Keyword List
